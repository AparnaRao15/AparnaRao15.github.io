<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Garden ðŸŒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- stop cache so you never need ?v=5 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root { --panel:#fff; --line:#e5e7eb; --text:#333; --muted:#666; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin:0; padding:24px; background:#f7faf9 }
    .wrap { max-width:960px; margin:0 auto }
    h1 { margin:0 0 8px }
    .sub { color:#555; margin-bottom:16px }
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; margin-bottom:16px }
    #garden { width:100%; height:560px; border:1px solid var(--line); border-radius:16px; position:relative; overflow:hidden }
    .garden-bg { position:absolute; inset:0; background:linear-gradient(#dff6ff,#e8fff3 40%,#e6f7e9 60%) }
    .meadow { position:absolute; left:0; right:0; bottom:0; height:35%; background:repeating-linear-gradient(0deg,#bde5c8,#bde5c8 8px,#c8edcf 8px,#c8edcf 16px) }
    .tooltip { position:fixed; pointer-events:none; background:#111; color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; opacity:0; transform:translateY(-6px); transition:opacity .12s ease }
    .legend { display:flex; flex-wrap:wrap; gap:8px; font-size:12px }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#fff }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block }
    a.button, button.button { display:inline-block; padding:8px 12px; background:#111; color:#fff; border-radius:12px; text-decoration:none; border:none; cursor:pointer }
    .button.alt { background:#444 }
    .debug { font-size:11px; color:#777; margin-top:8px }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Data Garden ðŸŒ¼</h1>
  <p class="sub">Plant a data point â†’ watch the visualization grow. Size = minutes/day learning, color = favorite tool, height = self-rated skill.</p>

  <!-- Submit panel -->
  <div class="panel">
    <a class="button" id="plant-btn"
       href="https://docs.google.com/forms/d/e/1FAIpQLSchoCnZwWKI7XzsMgTr1FESyJajLRIgOgVBQZJDn3dNyahrxw/viewform"
       target="_blank" rel="noopener">Plant your flower</a>
    <span style="margin-left:8px;font-size:12px;color:#666">opens a short form (10s)</span>
    <div class="debug" id="debug"></div>
  </div>

  <!-- View toggle -->
  <div class="panel row">
    <strong style="font-size:14px">View:</strong>
    <button id="mode-garden" class="button">Garden</button>
    <button id="mode-constellation" class="button alt">Constellation</button>
    <span style="font-size:12px;color:#666">size = minutes/day â€¢ color = tool â€¢ height = skill</span>
  </div>

  <!-- Viz surface -->
  <div id="garden" class="panel">
    <div class="garden-bg" id="bg"></div>
    <svg id="svg" viewBox="0 0 960 560" preserveAspectRatio="xMidYMid slice"
         style="width:100%;height:100%;border-radius:12px"></svg>
    <div class="meadow" id="meadow"></div>
  </div>

  <div class="panel">
    <div class="legend" id="legend"></div>
    <p style="font-size:12px;color:#666;margin-top:8px">Tip: hover a point to see details. Data refreshes every 60s.</p>
  </div>

  <div class="panel" style="font-size:13px;color:#333">
    <strong>How it works:</strong> Google Form â†’ Google Sheet â†’ Publish to web (CSV). This page fetches the CSV and plots each row.
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<!-- PapaParse for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/** ======== SETTINGS (edit this) ======== **/
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZEu61YnxeU17XTECpbKuVE096N4aVDqB2wARiB8HlMzQwsP4iwR7BtG5iqHaHuJOKNNr7aJAuaI0Z/pub?output=csv";
/** columns must match your sheet headers exactly */
const TOOL_COLUMN    = "favorite_tool";
const MINUTES_COLUMN = "minute_per_day";
const SKILL_COLUMN   = "skill_self_rating";
const NAME_COLUMN    = "name_or_alias";
/** ====================================== **/

let MODE = "garden"; // "garden" | "constellation"

const svg = document.getElementById("svg");
const legend = document.getElementById("legend");
const tip = document.getElementById("tooltip");
const debug = document.getElementById("debug");
const bg = document.getElementById("bg");
const meadow = document.getElementById("meadow");
const W = 960, H = 560, PAD = 24;

document.getElementById("mode-garden").onclick = () => { MODE="garden"; applyModeChrome(); loadAndRender(); };
document.getElementById("mode-constellation").onclick = () => { MODE="constellation"; applyModeChrome(); loadAndRender(); };
function applyModeChrome(){
  // button styles
  document.getElementById("mode-garden").classList.toggle("alt", MODE!=="garden");
  document.getElementById("mode-constellation").classList.toggle("alt", MODE!=="constellation");
  // background chrome
  if (MODE==="garden"){ bg.style.display="block"; meadow.style.display="block"; }
  else { bg.style.display="none"; meadow.style.display="none"; }
}

function scaleLinear([d0,d1],[r0,r1]) {
  const m = (r1-r0)/(d1-d0 || 1);
  return (x)=> r0 + (x-d0)*m;
}
function colorFor(str) { // deterministic HSL by string
  let h = 0; for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
  return `hsl(${h % 360},70%,45%)`;
}

function clearSVG(){
  while (svg.firstChild) svg.removeChild(svg.firstChild);
}

function renderGarden(data){
  clearSVG(); legend.innerHTML="";
  // coerce + clamp
  const minutes = data.map(d => +d[MINUTES_COLUMN] || 0);
  const skill   = data.map(d => +d[SKILL_COLUMN]   || 0);
  const minMin = 0, maxMin = Math.max(60, Math.min(240, Math.max(...minutes, 60)));
  const minSkill = 0, maxSkill = Math.max(5, Math.max(...skill, 5));
  const x = scaleLinear([minMin, maxMin],[PAD, W-PAD]);
  const y = scaleLinear([minSkill, maxSkill],[H-PAD-140, PAD]); // keep above meadow
  const r = (m)=> Math.max(6, Math.min(36, (m/ maxMin) * 36));  // size by minutes

  // axes
  const ax = document.createElementNS("http://www.w3.org/2000/svg","g");
  ax.setAttribute("stroke","#e5e7eb"); ax.setAttribute("stroke-width","1");
  const xAxis = document.createElementNS("http://www.w3.org/2000/svg","line");
  xAxis.setAttribute("x1", PAD); xAxis.setAttribute("y1", H-PAD-140);
  xAxis.setAttribute("x2", W-PAD); xAxis.setAttribute("y2", H-PAD-140);
  ax.appendChild(xAxis);
  const yAxis = document.createElementNS("http://www.w3.org/2000/svg","line");
  yAxis.setAttribute("x1", PAD); yAxis.setAttribute("y1", H-PAD-140);
  yAxis.setAttribute("x2", PAD); yAxis.setAttribute("y2", PAD);
  ax.appendChild(yAxis);
  svg.appendChild(ax);

  // flowers
  data.forEach(d => {
    const tool = (d[TOOL_COLUMN] || "Unknown").trim();
    const cx = x(+d[MINUTES_COLUMN] || 0);
    const cy = y(+d[SKILL_COLUMN]   || 0);
    const rad = r(+d[MINUTES_COLUMN] || 0);
    const col = colorFor(tool);

    const stem = document.createElementNS("http://www.w3.org/2000/svg","line");
    stem.setAttribute("x1", cx); stem.setAttribute("x2", cx);
    stem.setAttribute("y1", H-PAD-40); stem.setAttribute("y2", cy);
    stem.setAttribute("stroke", "#6bbf87"); stem.setAttribute("stroke-width", "2");
    svg.appendChild(stem);

    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx", cx); c.setAttribute("cy", cy); c.setAttribute("r", rad);
    c.setAttribute("fill", col); c.setAttribute("fill-opacity","0.9");
    c.setAttribute("stroke","#fff"); c.setAttribute("stroke-width","2");
    g.appendChild(c);
    const k = document.createElementNS("http://www.w3.org/2000/svg","circle");
    k.setAttribute("cx", cx); k.setAttribute("cy", cy); k.setAttribute("r", Math.max(3, rad*0.35));
    k.setAttribute("fill", "rgba(0,0,0,.15)");
    g.appendChild(k);

    g.addEventListener("mousemove",(ev)=>{
      const alias = (d[NAME_COLUMN] || "").trim();
      tip.style.opacity=1; tip.style.left=(ev.clientX+12)+"px"; tip.style.top=(ev.clientY+12)+"px";
      tip.textContent = `${alias?alias+" Â· ":""}${tool} Â· ${d[MINUTES_COLUMN]} min/day Â· skill ${d[SKILL_COLUMN]}`;
    });
    g.addEventListener("mouseleave",()=> tip.style.opacity=0);
    svg.appendChild(g);
  });

  // legend
  Array.from(new Set(data.map(d => (d[TOOL_COLUMN]||"Unknown").trim()))).slice(0,12)
    .forEach(t => { const item=document.createElement("span"); item.className="badge";
      const dot=document.createElement("span"); dot.className="dot"; dot.style.background=colorFor(t);
      const label=document.createElement("span"); label.textContent=t||"Unknown";
      item.appendChild(dot); item.appendChild(label); legend.appendChild(item); });
}

function renderConstellation(data){
  clearSVG(); legend.innerHTML="";
  // background sky gradient (inside SVG)
  const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
  const grad = document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
  grad.setAttribute("id","sky"); grad.setAttribute("x1","0"); grad.setAttribute("x2","0");
  grad.setAttribute("y1","0"); grad.setAttribute("y2","1");
  const s1=document.createElementNS("http://www.w3.org/2000/svg","stop"); s1.setAttribute("offset","0%"); s1.setAttribute("stop-color","#0b1020");
  const s2=document.createElementNS("http://www.w3.org/2000/svg","stop"); s2.setAttribute("offset","100%"); s2.setAttribute("stop-color","#141a33");
  grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);
  const sky = document.createElementNS("http://www.w3.org/2000/svg","rect");
  sky.setAttribute("x",0); sky.setAttribute("y",0); sky.setAttribute("width","960"); sky.setAttribute("height","560"); sky.setAttribute("fill","url(#sky)");
  svg.appendChild(sky);

  // scales (reuse garden logic)
  const minutes = data.map(d => +d[MINUTES_COLUMN] || 0);
  const skill   = data.map(d => +d[SKILL_COLUMN]   || 0);
  const minMin = 0, maxMin = Math.max(60, Math.min(240, Math.max(...minutes, 60)));
  const minSkill = 0, maxSkill = Math.max(5, Math.max(...skill, 5));
  const x = scaleLinear([minMin, maxMin],[PAD, W-PAD]);
  const y = scaleLinear([minSkill, maxSkill],[H-PAD, PAD]);

  // build stars
  const stars = data.map(d => ({
    x: x(+d[MINUTES_COLUMN] || 0),
    y: y(+d[SKILL_COLUMN]   || 0),
    r: Math.max(2, Math.min(5, (+d[MINUTES_COLUMN]||0)/maxMin*6)),
    tool: (d[TOOL_COLUMN] || "Unknown").trim(),
    alias: (d[NAME_COLUMN] || "").trim(),
    minutes: +d[MINUTES_COLUMN] || 0,
    skill: +d[SKILL_COLUMN] || 0
  }));

  // connect near neighbors
  const maxEdges = 200; let edges=0;
  for (let i=0;i<stars.length;i++){
    for (let j=i+1;j<stars.length && edges<maxEdges;j++){
      const dx = stars[i].x - stars[j].x, dy = stars[i].y - stars[j].y;
      const d = Math.hypot(dx,dy);
      if (d < 110){
        const ln = document.createElementNS("http://www.w3.org/2000/svg","line");
        ln.setAttribute("x1",stars[i].x); ln.setAttribute("y1",stars[i].y);
        ln.setAttribute("x2",stars[j].x); ln.setAttribute("y2",stars[j].y);
        ln.setAttribute("stroke","rgba(255,255,255,.35)"); ln.setAttribute("stroke-width","1");
        svg.appendChild(ln); edges++;
      }
    }
  }

  // draw stars
  stars.forEach(s=>{
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    const star = document.createElementNS("http://www.w3.org/2000/svg","circle");
    star.setAttribute("cx", s.x); star.setAttribute("cy", s.y); star.setAttribute("r", s.r);
    star.setAttribute("fill", "#fff"); star.setAttribute("stroke", colorFor(s.tool)); star.setAttribute("stroke-width","2");
    g.appendChild(star);
    g.addEventListener("mousemove",(ev)=>{
      tip.style.opacity=1; tip.style.left=(ev.clientX+12)+"px"; tip.style.top=(ev.clientY+12)+"px";
      tip.textContent = `${s.alias? s.alias+" Â· " : ""}${s.tool} Â· ${s.minutes} min/day Â· skill ${s.skill}`;
    });
    g.addEventListener("mouseleave",()=> tip.style.opacity=0);
    svg.appendChild(g);
  });

  // legend
  Array.from(new Set(stars.map(s=>s.tool))).slice(0,12)
    .forEach(t=>{ const item=document.createElement("span"); item.className="badge";
      const dot=document.createElement("span"); dot.className="dot"; dot.style.background=colorFor(t);
      const label=document.createElement("span"); label.textContent=t||"Unknown";
      item.appendChild(dot); item.appendChild(label); legend.appendChild(item); });
}

async function loadAndRender(){
  try{
    const res = await fetch(SHEET_CSV_URL, { cache:"no-store" });
    const csv = await res.text();
    const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
    if (debug) {
      const btn = document.getElementById("plant-btn");
      debug.textContent = `Loaded ${parsed.data.length} row(s) â€¢ Button href: ${btn ? btn.href : "N/A"}`;
    }
    (MODE === "garden" ? renderGarden : renderConstellation)(parsed.data);
  }catch(e){
    console.error(e);
    if (debug) debug.textContent = "Failed to load CSV. Is the link public?";
  }
}

applyModeChrome();
loadAndRender();
setInterval(loadAndRender, 60000); // refresh every 60s
</script>
</body>
</html>
